{% extends 'layouts/base.html' %}
{% load bootstrap4 static i18n %}

{% block progress-bar %}
    {% include 'common/progress_bar.html' with percentage=66 %}
{% endblock progress-bar %}

{% block content %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <img src="{% static 'images/bg-left-horizontal-waves.png' %}" class="bg-left-horizontal-waves"/>
                <form method="post">{% csrf_token %}
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <div class="fs20 lh46 mb-1 text-regular-family">
                                    {% translate 'Enter New Issue' %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="fs56 lh46 text-primary text-bold-family mb-4">
                                    {% translate 'Step' %} 4
                                </div>
                                <div class="fs35 lh35 text-bold-family ">
                                    {% translate 'Location of Issue or Feedback' %}
                                </div>
                            </div>
                            <div class="col-6">
                                {% bootstrap_form form layout='horizontal' %}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer mb-2" style="margin-top: 120px">
                        <button id="next" type="submit" class="btn btn-primary btn-sm rounded-xl float-right" disabled>
                            {% translate "SAVE & NEXT" %}
                        </button>
                        <a href="{% url 'dashboard:grm:new_issue_step_3' doc.auto_increment_id %}"
                           class="btn btn-primary btn-sm rounded-xl float-right mr-4 disabled-on-submit">
                            <i class="fa fa-chevron-left mr-2"></i>
                            {% translate "BACK" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block select2 %}
    <script type="text/javascript">
        $("#id_administrative_region").select2({
            placeholder: "{% translate 'Click to select location' %}",
            allowClear: true
        });

        function changeRegionTrigger() {
            $(".region").change(function () {
                $("#id_administrative_region_value").val($("select.region:last").val());
                loadNextLevelRegions($(this));
            });
        }
        changeRegionTrigger();

        let administrative_region_value = $("#id_administrative_region_value").val();
        let ancestors = [];
        $.ajax({
            type: 'GET',
            url: '{% url 'dashboard:grm:get_ancestor_administrative_levels' %}',
            data: {
                administrative_id: administrative_region_value,
            },
            success: function (data) {
                if (data.length > 0) {
                    data = data.slice(1);
                    data.push(administrative_region_value);
                    ancestors = data;
                    loadNextLevelRegions($("select.region:last"));
                } else {
                    $('#next').prop('disabled', false);
                }
            },
            error: function () {
                alert(error_server_message);
            }
        });

        function loadNextLevelRegions(current_level) {
            let current_level_val = current_level.val();
            if (current_level_val !== '') {
                let select_region = $(".region");
                select_region.attr('disabled', true);
                $.ajax({
                    type: 'GET',
                    url: '{% url 'dashboard:grm:get_choices_for_next_administrative_level' %}',
                    data: {
                        parent_id: current_level_val,
                    },
                    success: function (data) {
                        if (data.length > 0) {
                            let id_select = 'id_' + data[0].administrative_level;
                            let label = data[0].administrative_level.replace(/^\w/, (c) => c.toUpperCase());
                            let child;
                            let new_input = document.createElement('div');
                            new_input.className = 'form-group row dynamic-select';

                            let label_element = document.createElement('label');
                            label_element.className = 'col-md-3 col-form-label';
                            label_element.setAttribute('for', id_select);
                            label_element.innerHTML = label;
                            new_input.appendChild(label_element);

                            let div_element = document.createElement('div');
                            div_element.className = 'col-md-9';

                            let select_element = document.createElement('select');
                            select_element.className = 'form-control region';
                            select_element.setAttribute("required", "");
                            select_element.setAttribute('id', id_select);
                            div_element.appendChild(select_element);

                            new_input.appendChild(div_element);

                            current_level.parent().parent().after(new_input);
                            child = current_level.closest('.form-group').next().find('.region');
                            child.select2({
                                allowClear: true,
                                placeholder: "{% translate 'Click to select location' %}",
                            });
                            changeRegionTrigger();

                            let options = '<option value></option>';
                            $.each(data, function (index, value) {
                                let administrative_id = value.administrative_id;
                                let option = '<option value="' + administrative_id;
                                if (ancestors.includes(administrative_id)) {
                                    option += '" selected="selected">';
                                    ancestors = ancestors.filter(function (ancestor) {
                                        return ancestor !== administrative_id;
                                    });
                                } else {
                                    option += '">';
                                }
                                option += value.name + '</option>';
                                options += option

                            });
                            child.html(options);
                            child.trigger('change');
                            let child_val = child.val();
                            if (child_val !== '') {
                                child.val(child_val)
                            }
                        }
                    },
                    error: function () {
                        alert(error_server_message);
                    }
                }).done(function () {
                        if (ancestors.length === 0) {
                            select_region.attr('disabled', false);
                            $('#next').prop('disabled', false);
                        }
                    }
                );
            } else {
                let next_selects = current_level.closest('.form-group').nextAll('.dynamic-select');
                $.each(next_selects, function (index, select) {
                    select.remove();
                });
            }
        }
    </script>
{% endblock select2 %}
