{% extends 'layouts/base.html' %}
{% load i18n static %}

{% block extracss %}
    {{ block.super }}
    <link href="{% static 'plugins/mapbox-gl-js/v2.6.1/mapbox-gl.css' %}" rel="stylesheet">
    <style>
        #map {
            height: 600px;
        }

    </style>
{% endblock extracss %}

{% block content %}

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body issues-filter">
                    <div class="row">
                        <div class="col-4 text-left">
                            <div class="fs28 lh35 text-primary text-bold-family mb-4">
                                {% translate 'Filter by' %}<br>
                            </div>
                        </div>
                        <div class="col-2">
{#                                    {% bootstrap_field form.start_date layout='horizontal' %}#}
                            form.start_date layout='horizontal'
                        </div>
                        <div class="col-2">
{#                                    {% bootstrap_field form.end_date layout='horizontal' %}#}
                            form.end_date layout='horizontal'
                        </div>
                        <div class="col-2">
{#                                    {% bootstrap_field form.type show_label=False %}#}
                            form.type show_label=False
                        </div>
                        <div class="col-2">
{#                                    {% bootstrap_field form.category show_label=False %}#}
                            form.category show_label=False
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
{#                                    {% bootstrap_field form.region show_label=False %}#}
                            form.region show_label=False <br>
                        </div>
                    </div>
                    <a class="btn fs12 text-bold-family text-primary pull-right p-0"
                       id="clear_all_filters">
                        {% translate "Clear all filters" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-6">
            <div class="card">
                <div class="card-body">
                    <div class="overlay-wrapper">
                        <div id="map"></div>
                        <div class="overlay z-index1000 issue-percentages-spin irs--round">
                            <i class="fas fa-3x fa-sync-alt fa-spin">
                            </i>
                        </div>
                        <pre id="info"></pre>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card">
                <div class="card-body table-responsive">
                    <table id="table" class="table">
                        <thead class="primary">
                        <tr>
                            <th>{{ administrative_level }}</th>
                            <th>{% translate 'Number' %}</th>
                            <th>{% translate 'Percentage' %}</th>
                        </tr>
                        </thead>
                        <tbody id="issue-percentages-table">
                        </tbody>
                    </table>
                </div>
                <div class="overlay issue-percentages-spin">
                    <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascript %}
    {{ block.super }}
    <script src="{% static 'plugins/mapbox-gl-js/v2.6.1/mapbox-gl.js' %}"></script>
    <script>
        let issue_percentage_spin = $('.issue-percentages-spin');

        mapboxgl.accessToken = '{{ access_token }}';
        if (!mapboxgl.supported()) {
            alert('Your browser does not support Mapbox GL');
        } else {
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [{{ lng }}, {{ lat }}],
                zoom: {{ zoom }}
            });

            const bounds = [
                {{ ws_bound }}, // [west, south]
                {{ en_bound }}  // [east, north]
            ];
            // Set the map's max bounds.
            map.setMaxBounds(bounds);

            map.on('load', function () {
                map.addLayer(
                    {
                        'id': 'country-boundaries',
                        'source': {
                            'type': 'vector',
                            'url': 'mapbox://mapbox.country-boundaries-v1',
                        },
                        'source-layer': 'country_boundaries',
                        'type': 'fill',
                        'paint': {
                            'fill-color': '#d2361e',
                            'fill-opacity': 0.2,
                        },
                    },
                    'country-label'
                );


                map.setFilter('country-boundaries', [
                    "in",
                    "iso_3166_1_alpha_3",
                    '{{ country_iso_code }}',
                ]);

                setTimeout(function () {
                    issue_percentage_spin.hide();
                }, 1000);
            });

            map.on('styledata', (e) => {
                issue_percentage_spin.show();
            });

            map.on('idle', (e) => {
                setTimeout(function () {
                    issue_percentage_spin.hide();
                }, 96000);
            });

            $.ajax({
                type: 'GET',
                url: '{% url 'dashboard:diagnostics:issues_percentages' %}',
                success: function (data) {
                    $.each(data, function (administrative_id, region) {
                        // create DOM element for the marker
                        const el = document.createElement('div');
                        el.className = 'map-marker';
                        el.title = region.name;
                        el.textContent = region.percentage + '%';

                        // create the marker
                        new mapboxgl.Marker(el)
                            .setLngLat([region.longitude, region.latitude])
                            .addTo(map);

                        const tr = document.createElement('tr');
                        const td_name = document.createElement('td');
                        td_name.innerHTML = region.name;
                        tr.appendChild(td_name);
                        const td_issues = document.createElement('td');
                        td_issues.innerHTML = region.issues;
                        tr.appendChild(td_issues);
                        const td_percentage = document.createElement('td');
                        td_percentage.innerHTML = region.percentage + '%';
                        tr.appendChild(td_percentage);
                        $('#issue-percentages-table').append(tr)
                    });
                },
                error: function (data) {
                    alert(error_server_message + "Error " + data.status);
                }
            });
        }
    </script>
{% endblock javascript %}
