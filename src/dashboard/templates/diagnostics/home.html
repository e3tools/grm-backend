{% extends 'layouts/base.html' %}
{% load i18n static %}

{% block extracss %}
    {{ block.super }}
    <link href="{% static 'plugins/mapbox-gl-js/v2.6.1/mapbox-gl.css' %}" rel="stylesheet">
    <style>
        #map {
            height: 800px;
        }

    </style>
{% endblock extracss %}

{% block content %}
    <div class="col">
        <div class="overlay-wrapper">
            <div id="map"></div>
            <div class="overlay z-index1000 map-spin irs--round">
                <i class="fas fa-3x fa-sync-alt fa-spin">
                </i>
            </div>
            <pre id="info"></pre>
        </div>
    </div>
{% endblock content %}

{% block javascript %}
    {{ block.super }}
    <script src="{% static 'plugins/mapbox-gl-js/v2.6.1/mapbox-gl.js' %}"></script>
    <script>
        let map_spin = $('.map-spin');

        mapboxgl.accessToken = '{{ access_token }}';
        if (!mapboxgl.supported()) {
            alert('Your browser does not support Mapbox GL');
        } else {
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [{{ lng }}, {{ lat }}],
                zoom: {{ zoom }}
            });

            const bounds = [
                {{ ws_bound }}, // [west, south]
                {{ en_bound }}  // [east, north]
            ];
            // Set the map's max bounds.
            map.setMaxBounds(bounds);

            map.on('load', function () {
                map.addLayer(
                    {
                        'id': 'country-boundaries',
                        'source': {
                            'type': 'vector',
                            'url': 'mapbox://mapbox.country-boundaries-v1',
                        },
                        'source-layer': 'country_boundaries',
                        'type': 'fill',
                        'paint': {
                            'fill-color': '#d2361e',
                            'fill-opacity': 0.2,
                        },
                    },
                    'country-label'
                );


                map.setFilter('country-boundaries', [
                    "in",
                    "iso_3166_1_alpha_3",
                    '{{ country_iso_code }}',
                ]);

                setTimeout(function () {
                    map_spin.hide();
                }, 1000);
            });

            map.on('styledata', (e) => {
                map_spin.show();
            });

            map.on('idle', (e) => {
                setTimeout(function () {
                    map_spin.hide();
                }, 96000);
            });

            $.ajax({
                type: 'GET',
                url: '{% url 'dashboard:diagnostics:issues_percentages' %}',
                success: function (data) {
                    $.each(data, function (administrative_id, region) {
                        // create DOM element for the marker
                        const el = document.createElement('div');
                        el.className = 'map-marker';
                        el.title = region.name;
                        el.textContent = region.percentage + '%';

                        // create the marker
                        new mapboxgl.Marker(el)
                            .setLngLat([region.longitude, region.latitude])
                            .addTo(map);
                    });
                },
                error: function () {
                    alert(error_server_message);
                }
            });
        }
    </script>
{% endblock javascript %}
